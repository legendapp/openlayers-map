<!--
`openlayers-map`
Displays a full bleed openlayers map

@demo demo/index.html 
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="openlayers-import.html">
<link rel="import" href="stamen-import.html">

<dom-module id="openlayers-map">
  <template>
    <style>
      :host {
        display: block;
      }

      .map {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
      }
    </style>

    <div id="map" class="map"></div>
  </template>

  <script>
    Polymer({
      is: 'openlayers-map',

      properties: {
        position: {
          type: Object,
          value: {
            "latitude": 42.5747630,
            "longitude": -70.7741700
          },
        },
        draggable: {
          type: Boolean,
          value: true
        },
        zoom: {
          type: Number,
          value: 15
        },
        stamenMap: {
          type: String,
          value: "watercolor"
        },
        features: {
          type: Array,
          value: []
        },
        map: Object,
        imageData: {
          type: String,
          notify: true,
          reflectToAttribute: true,
          value: "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"
        },
      },

      observers: [
        "recenterMap(position)",
        "clearAndRenderMarkers(features.features.*, map)"
      ],

      updateImageData: function() {
        setTimeout((function() {
          this.map.once('postcompose', (function(event) {
            var canvas = event.context.canvas;
            this.set('imageData', canvas.toDataURL('image/png'));
          }).bind(this));

          this.map.renderSync();
        }).bind(this), 1000)
      },

      clearAndRenderMarkers: function(splices) {
        if(!this.features || !this.map) return;


        var image = new ol.style.Circle({
          radius: 5,
          fill: new ol.style.Fill({color: "red"}),
          stroke: new ol.style.Stroke({color: 'red', width: 1})
        });

        var styles = {
          'Point': new ol.style.Style({
            image: image
          })
        };

        var vectorSource = new ol.source.Vector({
          features: (new ol.format.GeoJSON()).readFeatures(this.features, {featureProjection: 'EPSG:3857'})
        });

        var styleFunction = function(feature) {
          return styles[feature.getGeometry().getType()];
        };


        this.map.removeLayer(this.featuresLayer);
        this.featuresLayer = new ol.layer.Vector({
          source: vectorSource,
          style: styleFunction,
        });
        this.map.addLayer(this.featuresLayer);

        this.updateImageData();
      },

      recenterMap: function(position) {
        if(!this.map || !this.position) return;

        var coords = [this.position.coords.longitude, this.position.coords.latitude];
        this.map.getView().setCenter(ol.proj.fromLonLat(coords));

        this.updateImageData();
      },

      _initMap: function() {
        this.map = new ol.Map({
          renderer:'canvas',
          target: this.$.map,
          interactions: ol.interaction.defaults({
              // doubleClickZoom :false,
              dragAndDrop: false,
              dragPan: this.draggable,
              keyboardPan: false,
              keyboardZoom: false,
              // mouseWheelZoom: false,
              pointer: false,
              select: false
          }),
          layers: [
            new ol.layer.Tile({
              source: new ol.source.Stamen({
                layer: this.stamenMap
              })
            })
          ],
          view: new ol.View({
            center: ol.proj.fromLonLat([this.position.longitude, this.position.latitude]),
            zoom: this.zoom
          })
        });

        this.map.on("moveend", (function() {
          this.updateImageData();
        }).bind(this));

        // this.updateImageData();

        // this.push('features', { longitude: 42.5747630, latitude: -70.7741700 });
      },

      ready: function() {
        // window.addEventListener('WebComponentsReady', this._initMap.bind(this));
        this._initMap();
      }
    });
  </script>
</dom-module>
