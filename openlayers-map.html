<link rel="import" href="../polymer/polymer.html">
<link rel="stylesheet" href="http://openlayers.org/en/v3.17.1/css/ol.css" type="text/css">

<!--
`openlayers-map`
Displays a full bleed openlayers map

@demo demo/index.html 
-->

<dom-module id="openlayers-map">
  <template>
    <style>
      :host {
        display: block;
      }

      .map {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
      }
    </style>

    <div id="map" class="map"></div>
  </template>

  <script src="http://openlayers.org/en/v3.17.1/build/ol.js" type="text/javascript"></script>
  <script type="text/javascript" src="http://maps.stamen.com/js/tile.stamen.js?v1.3.0"></script>

  <script>
    Polymer({

      is: 'openlayers-map',

      properties: {
        position: {
          type: Object,
          value: {
            "latitude": 42.5747630,
            "longitude": -70.7741700
          },
        },
        draggable: {
          type: Boolean,
          value: true
        },
        zoom: {
          type: Number,
          value: 15
        },
        stamenMap: {
          type: String,
          value: "watercolor"
        },
        features: Array
      },

      observers: [
        "recenterMap(position)",
        "clearAndRenderMarkers(features.*)"
      ],

      clearAndRenderMarkers(splices) {
        if(!this.features) return;

        var iconFeatures=[];

        var iconStyle = new ol.style.Style({
          image: new ol.style.Icon(/** @type {olx.style.IconOptions} */ ({
            anchor: [0.5, 1],
            opacity: 0.75,
            scale: 0.05,
            src: 'images/map-marker-icon.png'
          }))
        });

        this.features.forEach(function(feature) {
          var iconFeature = new ol.Feature({
            geometry: new ol.geom.Point(ol.proj.transform([feature.longitude, feature.latitude], 'EPSG:4326', 'EPSG:3857')),
            name: 'Null Island',
            population: 4000,
            rainfall: 500
          });
          iconFeatures.push(iconFeature);
        });

        var vectorSource = new ol.source.Vector({
          features: iconFeatures
        });

        this.map.removeLayer(this.featuresLayer);
        this.featuresLayer = new ol.layer.Vector({
          source: vectorSource,
          style: iconStyle
        });
        this.map.addLayer(this.featuresLayer);
      },

      recenterMap(position) {
        if(!this.map || !this.position) return;

        var coords = [position.coords.longitude, position.coords.latitude];
        this.map.getView()
          .setCenter(ol.proj.transform(coords, 'EPSG:4326', 'EPSG:3857'));
      },

      ready: function() {
        this.map = new ol.Map({
          target: this.$.map,
          interactions: ol.interaction.defaults({
              // doubleClickZoom :false,
              dragAndDrop: false,
              dragPan: this.draggable,
              keyboardPan: false,
              keyboardZoom: false,
              // mouseWheelZoom: false,
              pointer: false,
              select: false
          }),
          layers: [
            new ol.layer.Tile({
              source: new ol.source.Stamen({
                layer: this.stamenMap
              })
            })
          ],
          view: new ol.View({
            zoom: this.zoom
          })
        });
      }
    });
  </script>
</dom-module>
